<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dev Workspace Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
      background: #f4f4f4;
    }
    h2 {
      margin-top: 2em;
    }
    form {
      background: #fff;
      padding: 1em;
      margin-bottom: 2em;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    input, button {
      padding: 0.5em;
      margin: 0.3em 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .log {
      background: #222;
      color: #0f0;
      padding: 0.5em;
      font-family: monospace;
      overflow-y: auto;
      max-height: 200px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background: #fff;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 0.5em;
      text-align: left;
    }
  </style>
</head>
<body>

  <h1>Dev Workspace Launcher</h1>

  <!-- üå± Start Workspace -->
  <form id="workspace-form">
    <h2>üöÄ Start a Workspace</h2>
    <label>Repo URL:</label>
    <input type="text" name="repo" value="https://github.com/HARSHALJETHWA19/ansible-project" required>
    
    <label>Username:</label>
    <input type="text" name="username" value="admin" required>

    <label>Prebuilt image (optional):</label>
    <input type="text" name="prebuilt_image" placeholder="ghcr.io/org/repo-devcontainer:sha">

    <label>
      <input type="checkbox" id="reuseVolume"> Reuse my previous workspace
    </label>

    <label>Custom Volume (optional):</label>
    <select id="volumeSelector">
      <option value="">-- Select Existing Volume --</option>
    </select>


    <button type="submit">Launch</button>
    <pre class="log" id="workspace-log"></pre>
  </form>

  <!-- üíæ Prebuild Mapping -->
  <form id="prebuild-form">
    <h2>üíæ Prebuild Mapping (SQLite)</h2>
    <label>Repo URL:</label>
    <input type="text" name="repo" value="https://github.com/HARSHALJETHWA19/ansible-project" required>

    <label>Image:</label>
    <input type="text" name="image" value="mcr.microsoft.com/devcontainers/dotnet:9.0" required>

    <button type="submit">Save Mapping</button>
    <pre class="log" id="prebuild-log"></pre>
  </form>

  <!-- üìä Live Dashboard -->
  <div>
    <h2>üìä Live Dashboard</h2>
    <button onclick="refreshWorkspaces()">üîÑ Refresh</button>
    <table id="workspace-table">
      <thead>
  <tr>
    <th>Container ID</th>
    <th>Image</th>
    <th>Name</th>
    <th>Port</th>
    <th>Status</th> <!-- ‚úÖ added -->
    <th>Last Ping</th>
    <th>Action</th>
  </tr>
</thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const base = "http://localhost:8000"; // API base

    const wsForm = document.getElementById("workspace-form");
    const prebuildForm = document.getElementById("prebuild-form");
    const wsLog = document.getElementById("workspace-log");
    const pbLog = document.getElementById("prebuild-log");
    const wsTableBody = document.querySelector("#workspace-table tbody");
    // const reuseVolume = document.getElementById('reuseVolume').checked;

    // formData.append('reuse_volume', reuseVolume);

    // üå± Launch Workspace
    wsForm.onsubmit = async (e) => {
      e.preventDefault();
      wsLog.textContent = "Starting...";
      const formData = new FormData(wsForm);

      const reuseVolume = document.getElementById('reuseVolume').checked;
      formData.append('reuse_volume', reuseVolume); // ‚úÖ Move here

      const volumeSelector = document.getElementById("volumeSelector");
      const selectedVolume = volumeSelector.value;
      if (selectedVolume) {
        formData.append("custom_volume_name", selectedVolume);
      }


      const res = await fetch(`${base}/start-workspace`, {
        method: "POST",
        body: formData
      });
      const json = await res.json();
      wsLog.textContent = JSON.stringify(json, null, 2);
      if (json.workspace_url) {
        const a = document.createElement("a");
        a.href = json.workspace_url;
        a.textContent = "üëâ Open IDE";
        a.target = "_blank";
        wsLog.appendChild(document.createElement("br"));
        wsLog.appendChild(a);
      }
      refreshWorkspaces();
    };

    // üíæ Save Prebuild Mapping
    prebuildForm.onsubmit = async (e) => {
      e.preventDefault();
      pbLog.textContent = "Saving...";
      const formData = new FormData(prebuildForm);
      const res = await fetch(`${base}/prebuild`, {
        method: "POST",
        body: formData
      });
      const json = await res.json();
      pbLog.textContent = JSON.stringify(json, null, 2);
    };

    // üìä Refresh Workspaces
    async function refreshWorkspaces() {
      const res = await fetch(`${base}/workspaces`);
      const data = await res.json();
      wsTableBody.innerHTML = "";
      data.forEach(w => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
  <td>${w.id}</td>
  <td>${w.image}</td>
  <td>${w.name}</td>
  <td>${w.ports}</td>
  <td>${w.last_ping ? new Date(w.last_ping * 1000).toLocaleString() : "?"}</td>
  <td style="color: ${w.status.includes('Up') ? 'green' : 'red'}">${w.status}</td>
  <td>
    ${w.status.includes("Up") ? `
      <button onclick="stopWorkspace('${w.id}')">‚è∏Ô∏è Stop</button>
    ` : `
      <button onclick="startWorkspace('${w.id}')">‚ñ∂Ô∏è Start</button>
    `}
    <button onclick="deleteWorkspace('${w.id}')">üóëÔ∏è Delete</button>
    <button onclick="checkUpdate('${w.id}', '${w.name}')">üîÑ Check Update</button>
  </td>
`;



        wsTableBody.appendChild(tr);
      });
    }

    // üõë Stop Workspace
    async function stopWorkspace(id) {
      await fetch(`${base}/stop-workspace`, {
        method: "POST",
        body: new URLSearchParams({ container_id: id })
      });
      refreshWorkspaces();
    }

    async function deleteWorkspace(id) {
  if (confirm(`Are you sure you want to delete workspace ${id}?`)) {
    await fetch(`${base}/delete-workspace`, {
      method: "POST",
      body: new URLSearchParams({ container_id: id })
    });
    refreshWorkspaces();
  }
}

async function startWorkspace(id) {
  await fetch(`${base}/start-container`, {
    method: "POST",
    body: new URLSearchParams({ container_id: id })
  });
  refreshWorkspaces();
}

async function checkUpdate(id, name) {
  const repo = document.querySelector('input[name="repo"]').value;
  const res = await fetch(`${base}/check-update?container_id=${id}&repo=${encodeURIComponent(repo)}`);
  const json = await res.json();

  alert(`Container ${id} is ${json.status.toUpperCase()}\nStored SHA: ${json.stored_sha}\nLatest SHA: ${json.latest_sha}`);

  if (json.status === "outdated") {
    if (confirm("Repo has changed. Do you want to REBUILD this workspace?")) {
      await rebuildWorkspace(id, repo, name.split("-")[0]); // extract username from container name
    }
  }
}

async function loadVolumes() {
  const res = await fetch(`${base}/volumes`);
  const data = await res.json();
  console.log("Fetched volumes:", data); // üîç Add this line

  const selector = document.getElementById("volumeSelector");
  data.volumes.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    selector.appendChild(opt);
  });
}



async function rebuildWorkspace(id, repo, username) {
  const image = document.querySelector('input[name="prebuilt_image"]').value;
  const body = new URLSearchParams({ container_id: id, repo, username });
  if (image) body.append("prebuilt_image", image);

  const res = await fetch(`${base}/rebuild-workspace`, {
    method: "POST",
    body
  });
  const json = await res.json();
  alert("Rebuilt workspace:\n" + JSON.stringify(json, null, 2));
  refreshWorkspaces();
}



    // üîÅ Initial load
    refreshWorkspaces();

    loadVolumes();

  </script>
</body>
</html>
