<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dev Workspace Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
      background: #f4f4f4;
    }
    h2 {
      margin-top: 2em;
    }
    form {
      background: #fff;
      padding: 1em;
      margin-bottom: 2em;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    input, button {
      padding: 0.5em;
      margin: 0.3em 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .log {
      background: #222;
      color: #0f0;
      padding: 0.5em;
      font-family: monospace;
      overflow-y: auto;
      max-height: 200px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background: #fff;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 0.5em;
      text-align: left;
    }
  </style>
</head>
<body>

<h1>Dev Workspace Launcher</h1>
<button onclick="logout()">üö™ Logout</button>

<!-- üîê Login -->
<form id="login-form">
  <h2>üîê Login</h2>
  <input type="text" id="login-username" placeholder="Username" required>
  <input type="password" id="login-password" placeholder="Password" required>
  <button type="submit">Login</button>
  <pre class="log" id="login-log"></pre>
</form>

<!-- üöÄ Start Workspace -->
<form id="workspace-form">
  <h2>üöÄ Start a Workspace</h2>
  <label>Repo URL:</label>
  <input type="text" name="repo" value="https://github.com/HARSHALJETHWA19/ansible-project" required>
  
  <label>Username:</label>
  <input type="text" name="username" value="admin" required>

  <label>Prebuilt image (optional):</label>
  <input type="text" name="prebuilt_image" placeholder="ghcr.io/org/repo-devcontainer:sha">

  <label><input type="checkbox" id="reuseVolume"> Reuse my previous workspace</label>

  <label>Custom Volume (optional):</label>
  <select id="volumeSelector">
    <option value="">-- Select Existing Volume --</option>
  </select>

  <button type="submit">Launch</button>
  <pre class="log" id="workspace-log"></pre>
</form>

<!-- ‚öôÔ∏è Devcontainer Generator -->
<form id="devcontainer-form">
  <h2>‚öôÔ∏è Generate .devcontainer.json</h2>
  <label>Repo URL:</label>
  <input type="text" name="repo" required value="https://github.com/HARSHALJETHWA19/ansible-project">

  <label>Language:</label>
  <select name="language" required>
    <option value="node">Node.js</option>
    <option value="python">Python</option>
    <option value="java">Java</option>
    <option value="go">Go</option>
    <option value="dotnet">.NET</option>
  </select>

  <label>Ports (comma-separated):</label>
  <input type="text" name="ports" placeholder="3000,8000">

  <label>Post Create Command:</label>
  <input type="text" name="post_create" placeholder="npm ci">

  <button type="submit">Generate</button>
  <pre class="log" id="dev-log"></pre>
</form>

<!-- üíæ Prebuild Mapping -->
<form id="prebuild-form">
  <h2>üíæ Prebuild Mapping (SQLite)</h2>
  <label>Repo URL:</label>
  <input type="text" name="repo" required value="https://github.com/HARSHALJETHWA19/ansible-project">

  <label>Image:</label>
  <input type="text" name="image" required value="mcr.microsoft.com/devcontainers/dotnet:9.0">

  <button type="submit">Save Mapping</button>
  <pre class="log" id="prebuild-log"></pre>
</form>

<!-- üìä Live Dashboard -->
<h2 id="dashboard-heading">üìä Live Dashboard</h2>
<button onclick="refreshWorkspaces()">üîÑ Refresh</button>
<table id="workspace-table">
  <thead>
    <tr>
      <th>Container ID</th>
      <th>Image</th>
      <th>Name</th>
      <th>Port</th>
      <th>Last Ping</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const base = "http://localhost:8000";

// Auth check
function isAuthenticated() {
  return !!localStorage.getItem("authToken");
}

function showDashboard() {
  document.getElementById("workspace-form").style.display = "block";
  document.getElementById("prebuild-form").style.display = "block";
  document.getElementById("workspace-table").style.display = "table";
  document.getElementById("devcontainer-form").style.display = "block";
  document.getElementById("dashboard-heading").style.display = "block";
  refreshWorkspaces();
  loadVolumes();
}

function hideDashboard() {
  document.getElementById("workspace-form").style.display = "none";
  document.getElementById("prebuild-form").style.display = "none";
  document.getElementById("workspace-table").style.display = "none";
  document.getElementById("devcontainer-form").style.display = "none";
  document.getElementById("dashboard-heading").style.display = "none";
}

if (isAuthenticated()) {
  showDashboard();
} else {
  hideDashboard();
}

function logout() {
  localStorage.removeItem("authToken");
  location.reload();
}

document.getElementById("login-form").onsubmit = async (e) => {
  e.preventDefault();
  const username = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;
  const log = document.getElementById("login-log");

  log.textContent = "Logging in...";

  const body = new URLSearchParams();
  body.append("username", username);
  body.append("password", password);

  const res = await fetch(`${base}/login`, {
    method: "POST",
    body
  });

  const json = await res.json();
  if (res.ok) {
    localStorage.setItem("authToken", json.token);
    log.textContent = "‚úÖ Logged in!";
    showDashboard();
  } else {
    log.textContent = "‚ùå Login failed: " + json.detail;
  }
};

document.getElementById("workspace-form").onsubmit = async (e) => {
  e.preventDefault();
  const wsLog = document.getElementById("workspace-log");
  wsLog.textContent = "Starting...";
  const formData = new FormData(e.target);

  const reuseVolume = document.getElementById('reuseVolume').checked;
  formData.append('reuse_volume', reuseVolume);

  const selectedVolume = document.getElementById("volumeSelector").value;
  if (selectedVolume) {
    formData.append("custom_volume_name", selectedVolume);
  }

  const res = await fetch(`${base}/start-workspace`, {
    method: "POST",
    body: formData,
    headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
  });

  const json = await res.json();
  wsLog.textContent = JSON.stringify(json, null, 2);
  if (json.workspace_url) {
    const a = document.createElement("a");
    a.href = json.workspace_url;
    a.textContent = "üëâ Open IDE";
    a.target = "_blank";
    wsLog.appendChild(document.createElement("br"));
    wsLog.appendChild(a);
  }
  refreshWorkspaces();
};

document.getElementById("prebuild-form").onsubmit = async (e) => {
  e.preventDefault();
  const log = document.getElementById("prebuild-log");
  log.textContent = "Saving...";
  const formData = new FormData(e.target);
  const res = await fetch(`${base}/prebuild`, {
    method: "POST",
    body: formData,
    headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
  });
  const json = await res.json();
  log.textContent = JSON.stringify(json, null, 2);
};

document.getElementById("devcontainer-form").onsubmit = async (e) => {
  e.preventDefault();
  const log = document.getElementById("dev-log");
  log.textContent = "Generating...";
  const formData = new FormData(e.target);
  const res = await fetch(`${base}/generate-devcontainer`, {
    method: "POST",
    body: formData,
    headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
  });
  const json = await res.json();
  log.textContent = JSON.stringify(json, null, 2);
};

async function refreshWorkspaces() {
  const res = await fetch(`${base}/workspaces`, {
  headers: {
    "Authorization": "Bearer " + localStorage.getItem("authToken")
  }
});
  const data = await res.json();
  const tbody = document.querySelector("#workspace-table tbody");
  tbody.innerHTML = "";
  data.forEach(w => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${w.id}</td>
      <td>${w.image}</td>
      <td>${w.name}</td>
      <td>${w.ports}</td>
      <td>${w.last_ping ? timeSince(w.last_ping) + " ago" : "?"}</td>
      <td style="color: ${w.status.includes('Up') ? 'green' : 'red'}">${w.status}</td>
      <td>
        ${w.status.includes("Up") ? `<button onclick="stopWorkspace('${w.id}')">‚è∏Ô∏è Stop</button>` : `<button onclick="startWorkspace('${w.id}')">‚ñ∂Ô∏è Start</button>`}
        <button onclick="deleteWorkspace('${w.id}')">üóëÔ∏è Delete</button>
        <button onclick="checkUpdate('${w.id}', '${w.name}')">üîÑ Check Update</button>
        <button onclick="showLogs('${w.id}')">üìú Logs</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function stopWorkspace(id) {
  await fetch(`${base}/stop-workspace`, {
    method: "POST",
    body: new URLSearchParams({ container_id: id }),
    headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
  });
  refreshWorkspaces();
}

async function deleteWorkspace(id) {
  if (confirm(`Delete workspace ${id}?`)) {
    await fetch(`${base}/delete-workspace`, {
      method: "POST",
      body: new URLSearchParams({ container_id: id }),
      headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
    });
    refreshWorkspaces();
  }
}

async function startWorkspace(id) {
  await fetch(`${base}/start-container`, {
    method: "POST",
    body: new URLSearchParams({ container_id: id }),
    headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
  });
  refreshWorkspaces();
}

async function showLogs(id) {
  const res = await fetch(`${base}/logs?id=${id}`, {
  headers: {
    "Authorization": "Bearer " + localStorage.getItem("authToken")
  }
});
  const json = await res.json();
  alert(`Logs for ${id}:\n\n` + json.logs);
}

async function checkUpdate(id, name) {
  const repo = document.querySelector('input[name="repo"]').value;
  const res = await fetch(`${base}/check-update?container_id=${id}&repo=${encodeURIComponent(repo)}`, {
  headers: {
    "Authorization": "Bearer " + localStorage.getItem("authToken")
  }
});
  
  const json = await res.json();

  alert(`Container ${id} is ${json.status.toUpperCase()}\nStored SHA: ${json.stored_sha}\nLatest SHA: ${json.latest_sha}`);

  if (json.status === "outdated") {
    if (confirm("Repo changed. Rebuild workspace?")) {
      await rebuildWorkspace(id, repo, name.split("-")[0]);
    }
  }
}

async function rebuildWorkspace(id, repo, username) {
  const image = document.querySelector('input[name="prebuilt_image"]').value;
  const body = new URLSearchParams({ container_id: id, repo, username });
  if (image) body.append("prebuilt_image", image);

  const res = await fetch(`${base}/rebuild-workspace`, {
    method: "POST",
    body,
    headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
  });
  const json = await res.json();
  alert("Rebuilt:\n" + JSON.stringify(json, null, 2));
  refreshWorkspaces();
}

async function loadVolumes() {
  const res = await fetch(`${base}/volumes`);
  const data = await res.json();
  const selector = document.getElementById("volumeSelector");
  selector.innerHTML = `<option value="">-- Select Existing Volume --</option>`;
  data.volumes.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    selector.appendChild(opt);
  });
}

function timeSince(ts) {
  const seconds = Math.floor(Date.now() / 1000 - ts);
  const mins = Math.floor(seconds / 60);
  if (mins < 1) return `${seconds}s`;
  if (mins < 60) return `${mins}m`;
  const hours = Math.floor(mins / 60);
  return `${hours}h ${mins % 60}m`;
}
</script>
</body>
</html>
